//@@viewOn:imports
import mod from "module";
import { createVisualComponent } from "uu5g05";
import Plus4U5Decoration from "uu_plus4u5decorationg01";
//@@viewOff:imports

const STATICS = {
  //@@viewOn:statics
  uu5Tag: "<%= context.uu5Tag %>",
  sourceUu5Tag: "Plus4U5Decoration.<%= context.decorationComponentName %>",
  //@@viewOff:statics
};

const componentProps = <%= context.decorationComponentProps %>;
const propTypes = { ...Plus4U5Decoration.<%= context.decorationComponentName %>.propTypes };
for (let k in componentProps) delete propTypes[k]; // some props might be marked as required but we'll have them pre-set

let jsScriptUri = mod?.uri;
if (!jsScriptUri) {
  let lastScript = document.currentScript || Array.prototype.slice.call(document.getElementsByTagName("script"), -1)[0];
  jsScriptUri = lastScript?.src;
}
let libBaseUri = jsScriptUri ? jsScriptUri.toString().replace(/^(.*\/).*/, "$1") : "./";

function normalizeSrc(src) {
  return !src || src.match(/^[a-z]+:/i)
    ? src
    : libBaseUri + "assets/" + src.replace(/^\/+/, "").replace(/\\/g, "/");
}

const <%= context.uu5Tag %> = createVisualComponent({
  ...STATICS,

  //@@viewOn:propTypes
  propTypes,
  //@@viewOff:propTypes

  //@@viewOn:defaultProps
  defaultProps: {},
  //@@viewOff:defaultProps

  render(props) {
    //@@viewOn:private
    let { src, bgSrc } = props;
    if (src === undefined){
      src = componentProps.src;
      if (src && typeof src === "object") {
        src = {};
        for (let k in componentProps.src) src[k] = normalizeSrc(componentProps.src[k]);
      } else if (typeof src === "string") {
        src = normalizeSrc(src);
      }
    }

    if (bgSrc === undefined && componentProps.bgSrc) {
      bgSrc = normalizeSrc(componentProps.bgSrc);
    }
    //@@viewOff:private

    //@@viewOn:interface
    //@@viewOff:interface

    //@@viewOn:render
    return <Plus4U5Decoration.<%= context.decorationComponentName %> {...componentProps} {...props} src={src} bgSrc={bgSrc} />;
    //@@viewOff:render
  },
});

export { <%= context.uu5Tag %> };
