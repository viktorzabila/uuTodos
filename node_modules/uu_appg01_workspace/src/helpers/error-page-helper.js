"use strict";

const fs = require("fs");
const path = require("path");
const util = require("util");
const readFile = util.promisify(fs.readFile);
const ejs = require("ejs");

const { Uri, UriBuilder } = require("uu_appg01_core-uri");
const { UseCaseContext, ErrorConverter } = require("uu_appg01_core-appserver");

const UU_APP_ERROR_MAP_KEY = "uuAppErrorMap";

class ErrorPageHelper {
  static async respondWithErrorPage({ res, viewFile, params, error }) {
    const errorPage = await readFile(path.join(__dirname, "..", "views", viewFile), "utf8");
    res.locals.dispatchedError = { message: error.message, code: error.code }; // expected by auditLog for an error (5x) response
    res.status(503);
    res.send(ejs.compile(errorPage)(params));
  }

  /**
   * If uri contains error information - forwards to custom errorUve.
   * If not, redirects to the same page with parameters containing error information.
   */
  static redirectToCustomErrorPage(next, req, res, errorUc, error) {
    const uri = Uri.parse(res.locals.uri);
    const originUuAppErrorMap = uri.getParameters()[UU_APP_ERROR_MAP_KEY];
    if (originUuAppErrorMap && originUuAppErrorMap.includes(error.code)) {
      const newUri = UriBuilder.parse(res.locals.uri)
        .setUseCase(errorUc)
        .toUri();
      res.locals.uri = newUri;
      UseCaseContext.setUri(newUri);
      req.url = newUri.getRelativeUri().toString();
      res.locals.dispatchedError = { message: error.message, code: error.code }; // expected by auditLog for an error (5x) response
      res.status(503);
      res.locals.redirectToCustomErrorUve = true;
      next();
    } else {
      const { dtoOut } = ErrorConverter.buildErrorDtoOut(error);
      let uuAppErrorMap;
      try {
        uuAppErrorMap = JSON.parse(originUuAppErrorMap) || {};
      } catch (e) {
        uuAppErrorMap = {};
      }
      Object.assign(uuAppErrorMap, dtoOut.uuAppErrorMap);

      const newUriBuilder = UriBuilder.parse(res.locals._uu_app_uve_handler_orig_url || res.locals.uri)
        .deleteParameter(UU_APP_ERROR_MAP_KEY)
        .setParameter(UU_APP_ERROR_MAP_KEY, JSON.stringify(uuAppErrorMap));
      res.redirect(newUriBuilder.toString());
    }
  }
}

module.exports = ErrorPageHelper;
