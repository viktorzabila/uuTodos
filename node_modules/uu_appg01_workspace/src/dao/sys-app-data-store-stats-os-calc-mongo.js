const { DbConnection } = require("uu_appg01_datastore");

class SysAppDataStoreStatsOsCalcMongo {
  constructor(connectionString) {
    connectionString += connectionString.includes("?") ? "&" : "?";
    connectionString += "readPreference=secondaryPreferred"

    this.connectionString = connectionString;
    DbConnection.init(connectionString);
  }

  async calculate(awid, collectionName) {
    let db = await DbConnection.get(this.connectionString);
    let collectionInfo;

    let query;
    if (collectionName === "sysUuSubAppInstance") {
      query = { asid: awid };
    } else {
      query = { awid }
    }
    collectionInfo = await db
      .collection(collectionName)
      .mapReduce(
        "function () {" + "emit(0, {count: 1, dataSize: Object.bsonsize(this)});" + "}",
        "function (k, infos) {" +
          "var count = 0;" +
          "var dataSize = 0;" +
          "infos.forEach(function (info) {" +
          "count += info.count;" +
          "dataSize += info.dataSize;" +
          "});" +
          "return {count: count, dataSize: dataSize};" +
          "}",
        { out: { inline: 1 }, query }
      );

    let objectStats;
    if (!collectionInfo[0]) {
      objectStats = { count: 0, dataSize: 0 };
    } else {
      objectStats = collectionInfo[0].value;
    }

    if (objectStats["count"] > 0) {
      let collStats;
      collStats = await db.command({ collStats: collectionName });

      let totalIndexSize = collStats["totalIndexSize"];
      let totalCount = collStats["count"];
      objectStats.indexSize = ((totalIndexSize / totalCount) * objectStats["count"]);
      objectStats.size = objectStats.dataSize + objectStats.indexSize;

    } else {
      objectStats.size = objectStats.indexSize = 0;
    }

    return objectStats;
  }

  async getStats() {
    let db = await DbConnection.get(this.connectionString);
    return db.stats();
  }
}

module.exports = SysAppDataStoreStatsOsCalcMongo;
