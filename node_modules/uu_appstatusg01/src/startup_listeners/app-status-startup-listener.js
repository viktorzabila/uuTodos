"use strict";
const { LoggerFactory } = require("uu_appg01_core-logging");
const { AuthenticationService } = require("uu_appg01_core-authentication");

const LOGGER = LoggerFactory.get("Uu.AppStatus");

class AppStatusStartupListener {
  async onStartup() {
    const statusUpdater = require("../status-updater");
    if (!statusUpdater.progressUri) {
      LOGGER.warn(`Deployment parameter \"${statusUpdater.getAppStatusProgressBaseUriConfigName()}\" is not set. UuAppStatus monitoring is not started.`);
    } else if (!statusUpdater.progressUuEe && typeof AuthenticationService.authenticateSystemIdentity !== 'function') {
      LOGGER.warn(
        `System identity can be used only in uuAppServer 5.3+ in uuCloud. For older versions of uuAppServer, whitelisted uuEe have to be used but deployment parameter \"${statusUpdater.getAppStatusProgressUuEeConfigName()}\" is not set. UuAppStatus monitoring is not started.`);
    } else {
      await statusUpdater.update()

      setInterval(() => {
        statusUpdater.update()
      }, statusUpdater.getProgressUpdatePeriod() * 1000);
    }
  }
}

module.exports = AppStatusStartupListener;
