"use strict";

const MIDDLEWARE_ORDER = 150;

const UC_TYPE_UVE = "UVE";
const RESTORE_SESSION_PARAM = "uuAppOidcRestoreSessionOnLoad";
const INJECT_REGEXP = /((\s*)<head[^>]*>)/i


class AuthnConfigMiddleware {

  constructor() {
    this.name = "Authentication Configuration Middleware";
    this.order = MIDDLEWARE_ORDER;
  }

  post(req, res, next) {
    let ucProperties = res.locals.ucProperties;
    if (!ucProperties || ucProperties.getType() !== UC_TYPE_UVE) {
      return next();
    }

    let uuAppOidcRestoreSessionOnLoad = ucProperties.getAttribute(RESTORE_SESSION_PARAM);
    if (!uuAppOidcRestoreSessionOnLoad) {
      return next();
    }

    let uveContent = res.locals.response.body;
    if (!uveContent || (!Buffer.isBuffer(uveContent) && typeof uveContent !== "string")) {
      return next();
    }

    res.locals.response.body = uveContent.toString().replace(INJECT_REGEXP, `$1$2  <meta ${RESTORE_SESSION_PARAM}="${uuAppOidcRestoreSessionOnLoad}">`);
    next();
  }

}

module.exports = AuthnConfigMiddleware;
