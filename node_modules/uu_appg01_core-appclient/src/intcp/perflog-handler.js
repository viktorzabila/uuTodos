"use strict";

const { Perflog } = require("uu_appg01_core-perflog");
const { TokenSanitizer } = require("uu_appg01_core-authentication");

/**
 * Interceptor for performance logging.
 */
class PerfLogHandler {

  constructor(next, options = null) {
    this._next = next;
  }

  async invoke(request, options = null) {
    return new Promise((resolve, reject) => {
      Perflog.measureSection("UU_APP_CLIENT_REQUEST", async (section) => {
        request.headers["x-request-id"] = section.getId().toString();
        let uri = TokenSanitizer.processUri(request.uri.toString());
        section.setAttribute("uri", uri);
        try {
          resolve(await this._next.invoke(request, options));
        } catch (e) {
          reject(e);
        }
      });
    });
  }

}

module.exports = PerfLogHandler;
