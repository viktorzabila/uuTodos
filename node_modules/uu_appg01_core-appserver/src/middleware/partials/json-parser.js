"use strict";

const { Json } = require("uu_appg01_core-utils");
const BadRequest = require("../../error/bad-request.js");

const CT_HEADER = "content-type";
const JSON_TYPE = "application/json";
const STRING_TYPE = "string";

/**
 * MultipartParser uses Busboy to parse multipart bodies.
 */
function jsonParser(req, res, next) {
  let contentType = req.headers[CT_HEADER];
  if (contentType && contentType.includes(JSON_TYPE)) {
    if (!req.body) {
      req.body = {};
    } else if (typeof req.body === STRING_TYPE) {
      try {
        req.body = Json.parse(req.body);
      } catch (e) {
        return next(new BadRequest("Request body contains invalid JSON.", e));
      }
    }
  }
  next();
}

/**
 * Module exports jsonParser function.
 * @type {function}
 */
module.exports = jsonParser;
