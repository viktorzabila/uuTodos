"use strict";

const { LoggerFactory } = require("uu_appg01_core-logging");
const { Config, Finder } = require("uu_appg01_core-utils");
const App = require("express")();
const ExpressRouterBuilder = require("./endpoint/express-router-builder.js");

/**
 * ExpressBuilder takes care of attaching all necessary components to the Express framework.
 * @type {ExpressBuilder}
 */
class ExpressBuilder {

  build() {
    const logger = LoggerFactory.get("UuApp.AppServer");

    logger.debug("Setting view rendering engine to EJS.");
    App.set("view engine", "ejs");

    const viewsPaths = this._getViewsPaths();
    logger.debug(`Setting view source path to: ${viewsPaths}`);
    App.set("views", viewsPaths);

    logger.debug(`Setting query parser to Node.js native querystring library.`);
    App.set("query parser", "simple");

    App.disable("etag");
    App.disable('x-powered-by');

    logger.debug("Configuring Router.");
    let router = ExpressRouterBuilder.build();
    logger.debug("Adding Router to Express.");
    App.use("/", router);

    return App;
  }

  _getViewsPaths() {
    const root = Config.get("server_root");
    const PATH_TO_VIEWS = "{src,app}/views/";

    return Finder.findInModules(root, PATH_TO_VIEWS).concat(Finder.findInProject(root, PATH_TO_VIEWS));
  }
}

/**
 * Module exports a single instance of ExpressBuilder that is initialized
 * at application startup (when the first relevant require call is resolved).
 * @type {ExpressBuilder}
 */
module.exports = new ExpressBuilder();
