"use strict";

const { LoggerFactory } = require("uu_appg01_core-logging");
const v8 = require("v8");
const ErrorDispatcher = require("../middleware/partials/error-dispatcher.js");
const UseCaseError = require("../error/use-case-error.js");
const Sys = require("./sys.js");

let logger = LoggerFactory.get("UuApp.Appserver.TraceMemory");

/**
 * Allows to analyze memory.
 */
class TraceMemory {

  static call(ucEnv) {
    Sys.authorize(ucEnv);
    logger.info("MEMORY-TRACING");
    let heapSpaceStatistics = v8.getHeapSpaceStatistics();
    let params = v8.getHeapStatistics();
    params.heapSpaceStatistics = heapSpaceStatistics;
    params.currentTime = new Date().toISOString();
    ucEnv.getResponse().setStatus(200);
    ucEnv.getResponse().setHeader("Content-Type", "text/html");
    ucEnv
      .getResponse()
      .unwrap()
      .render("trace-memory", params, (err, html) => {
        if (err) {
          return ErrorDispatcher.dispatch(
            new UseCaseError("Error in rendering trace-memory.ejs template.", err),
            ucEnv.response,
            { htmlEnabled: true, verbose: true }
          );
        }
        ucEnv
          .getResponse()
          .unwrap()
          .send(html);
      });
  }

}

module.exports = TraceMemory;
