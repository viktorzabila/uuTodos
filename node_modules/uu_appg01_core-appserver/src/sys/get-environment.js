"use strict";

const Sys = require("./sys.js");
const Cp = require("child_process");

/**
 * Provides information about server runtime environment.
 */
class GetEnvironment {

  static async call(ucEnv) {
    Sys.authorize(ucEnv);
    let response = Object.assign({}, Sys.getAppInfo());
    let runtimeStack = process.env["UU_CLOUD_RUNTIME_STACK_CODE"];
    if (!runtimeStack) runtimeStack = `Node ${process.version}`;
    response.runtimeStack = runtimeStack;
    let [libraryList, errorMap] = await GetEnvironment._getListOfPackages();
    response.libraryList = libraryList;
    response.environmentVariables = process.env;
    response.uuAppErrorMap = errorMap || {};
    return response;
  }

  static async _getListOfPackages() {
    return new Promise((resolve, reject) => {
      Cp.exec("npm ls --long --parseable", (err, stdout, stderr) => {
        let pkgs = stdout.split("\n");
        let deps = new Set();
        pkgs.forEach(pkg => {
          let dep = pkg.split(":")[1];
          if (dep) {
            deps.add(dep);
          }
        });
        deps = Array.from(deps);
        deps.sort();
        let errorMap = null;
        if (err) {
          errorMap = {
            "uu-app-server/sysGetEnvironment/libraryListProblem" : {
              type: "warning",
              message: `Library list may be incomplete:\n${err}`
            }
          }
        }
        resolve([deps, errorMap]);
      });
    });
  }

}

module.exports = GetEnvironment;
