"use strict";

const Path = require("path");
const { Config, OptsReader } = require("uu_appg01_core-utils");
const AccessDenied = require("../error/access-denied.js");

/**
 * Class enabling system endpoints used for monitoring and runtime configuration. All contained
 * controllers are loaded using mappings.json located in the config folder of this library.
 */
class Sys {

  static authorize(ucEnv) {
    if (Config.isProfileActive("test", "development") || ucEnv.getUri().getHostname() === "localhost") {
      return;
    }
    let session = ucEnv.getSession();
    if (!session) {
      throw new AccessDenied("Logged user is not authorized to run use case.");
    }
    let loa = Number(session.getAuthenticationLevelOfAssurance());
    if (isNaN(loa) || loa == 0) {
      throw new AccessDenied("Logged user is not authorized to run use case.");
    }
  }

  /**
   * Method providing basic application info to be listed in all
   * provided outputs and statistics.
   */
  static getAppInfo() {
    let appInfo = Object.create(null);
    appInfo.uuSubApp = process.env["UU_CLOUD_APP_DEPLOYMENT_PACK"] || Sys._getPackageName();
    appInfo.uuSubAppVersion = process.env["UU_CLOUD_APP_VERSION"] || Sys._getVersion();
    return appInfo;
  }

  static getResponseMediaType() {
    // TODO
  }

  static _getVersion() {
    let version = "0.0.0";
    let pkg = Sys._getPackageJson();
    if (pkg.version) version = pkg.version;
    return version;
  }

  static _getPackageName() {
    let name = Sys._getServerRoot();
    name = name.substr(name.lastIndexOf("/") + 1, name.length);
    let pkg = Sys._getPackageJson();
    if (pkg.name) name = pkg.name;
    return name;
  }

  static _getPackageJson() {
    let serverRoot = Sys._getServerRoot();
    let pkgPath = Path.join(serverRoot, "package.json");
    return require(pkgPath);
  }

  static _getServerRoot() {
    let opts = new OptsReader(Config);
    return opts.getString("server_root", process.cwd());
  }

}

module.exports = Sys;
