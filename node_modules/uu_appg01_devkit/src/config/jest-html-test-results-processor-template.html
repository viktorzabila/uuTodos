<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test Results</title>

  <script>
    if (!location.href.match(/^(about:|file:)/)) {
      var bplCookie = document.cookie.match(/(^|;\s*)uu\.app\.bpl=([^;]+)/);
      var bplSegmentCount = (bplCookie ? Number(bplCookie[2]) : null);
      if (typeof bplSegmentCount !== "number" || isNaN(bplSegmentCount) || bplSegmentCount < 0) bplSegmentCount = 2;
      var appBaseUrlPath = (location.pathname.split(/\//).slice(0,1+bplSegmentCount).join("/")+"/").replace(/\/+/g,"/").replace(/"/g,"");
      var appAssetsRelativeUrlPath = "public/0.0.0/";
      document.write('<base href="' + appBaseUrlPath + appAssetsRelativeUrlPath + '" data-uu-app-base="' + appBaseUrlPath + '" data-uu-app-assets-base="' + appAssetsRelativeUrlPath + '">');
    }
  </script>

  <script src="https://cdn.plus4u.net/uu-uu5loaderg01/1.0.0/uu5loaderg01.min.js" crossorigin="anonymous"></script>

  <script>
    Uu5Loader.config({
      "imports": {
        "react": "https://cdn.plus4u.net/libs/react/16.13.1/react.min.js",
        "react-dom": "https://cdn.plus4u.net/libs/react-dom/16.13.1/react-dom.min.js",
        "create-react-class": "https://cdn.plus4u.net/libs/create-react-class/15.6.3/create-react-class.min.js",
        "prop-types": "https://cdn.plus4u.net/libs/prop-types/15.7.2/prop-types.min.js",

        "uu5g04": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04.min.js",
        "uu5g04-bricks": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04-bricks.min.js",
        "uu5g04-forms": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04-forms.min.js",
        "uu5g04-hooks": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04-hooks.min.js",
      }
    });

    // example test result value so that this template can be opened as-is and work fine
    var exampleTestData = {"numFailedTestSuites":1,"numFailedTests":1,"numPassedTestSuites":2,"numPassedTests":4,"numPendingTestSuites":0,"numPendingTests":1,"numRuntimeErrorTestSuites":0,"numTodoTests":0,"numTotalTestSuites":3,"numTotalTests":6,"openHandles":[],"snapshot":{"added":0,"didUpdate":false,"failure":false,"filesAdded":0,"filesRemoved":0,"filesRemovedList":[],"filesUnmatched":0,"filesUpdated":0,"matched":0,"total":0,"unchecked":0,"uncheckedKeysByFile":[],"unmatched":0,"updated":0},"startTime":1605620309495,"success":false,"testResults":[{"leaks":false,"numFailingTests":1,"numPassingTests":1,"numPendingTests":1,"numTodoTests":0,"openHandles":[],"perfStats":{"end":1605620312961,"runtime":2280,"slow":false,"start":1605620310681},"skipped":false,"snapshot":{"added":0,"fileDeleted":false,"matched":0,"unchecked":0,"unmatched":0,"updated":0,"uncheckedKeys":[]},"testFilePath":"C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\src\\ttt1.test.js","testResults":"[{\"ancestorTitles\":[],\"duration\":5,\"failureDetails\":[],\"failureMessages\":[],\"fullName\":\"root test\",\"location\":null,\"numPassingAsserts\":0,\"status\":\"passed\",\"title\":\"root test\"},{\"ancestorTitles\":[\"described section\"],\"duration\":4,\"failureDetails\":[{\"actual\":\"\",\"error\":{\"matcherResult\":{\"actual\":\"a\",\"expected\":\"b\",\"name\":\"toBe\",\"pass\":false}},\"expected\":\"\",\"matcherName\":\"\",\"message\":\"Error: \\u001b[2mexpect(\\u001b[22m\\u001b[31mreceived\\u001b[39m\\u001b[2m).\\u001b[22mtoBe\\u001b[2m(\\u001b[22m\\u001b[32mexpected\\u001b[39m\\u001b[2m) // Object.is equality\\u001b[22m\\n\\nExpected: \\u001b[32m\\\"b\\\"\\u001b[39m\\nReceived: \\u001b[31m\\\"a\\\"\\u001b[39m\",\"passed\":false,\"stack\":\"Error: \\u001b[2mexpect(\\u001b[22m\\u001b[31mreceived\\u001b[39m\\u001b[2m).\\u001b[22mtoBe\\u001b[2m(\\u001b[22m\\u001b[32mexpected\\u001b[39m\\u001b[2m) // Object.is equality\\u001b[22m\\n\\nExpected: \\u001b[32m\\\"b\\\"\\u001b[39m\\nReceived: \\u001b[31m\\\"a\\\"\\u001b[39m\\n    at Object.<anonymous> (C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\src\\\\ttt1.test.js:7:17)\\n    at Object.<anonymous> (C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\uu5g05-test\\\\src\\\\core.js:54:27)\\n    at Object.asyncJestTest (C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\jest-jasmine2\\\\build\\\\jasmineAsyncInstall.js:106:37)\\n    at C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\jest-jasmine2\\\\build\\\\queueRunner.js:45:12\\n    at new Promise (<anonymous>)\\n    at mapper (C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\jest-jasmine2\\\\build\\\\queueRunner.js:28:19)\\n    at C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\jest-jasmine2\\\\build\\\\queueRunner.js:75:41\"}],\"failureMessages\":[\"Error: \\u001b[2mexpect(\\u001b[22m\\u001b[31mreceived\\u001b[39m\\u001b[2m).\\u001b[22mtoBe\\u001b[2m(\\u001b[22m\\u001b[32mexpected\\u001b[39m\\u001b[2m) // Object.is equality\\u001b[22m\\n\\nExpected: \\u001b[32m\\\"b\\\"\\u001b[39m\\nReceived: \\u001b[31m\\\"a\\\"\\u001b[39m\\n    at Object.<anonymous> (C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\src\\\\ttt1.test.js:7:17)\\n    at Object.<anonymous> (C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\uu5g05-test\\\\src\\\\core.js:54:27)\\n    at Object.asyncJestTest (C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\jest-jasmine2\\\\build\\\\jasmineAsyncInstall.js:106:37)\\n    at C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\jest-jasmine2\\\\build\\\\queueRunner.js:45:12\\n    at new Promise (<anonymous>)\\n    at mapper (C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\jest-jasmine2\\\\build\\\\queueRunner.js:28:19)\\n    at C:\\\\Users\\\\Ma3oiS\\\\git\\\\uu_uu5g04\\\\uu5g04\\\\node_modules\\\\jest-jasmine2\\\\build\\\\queueRunner.js:75:41\"],\"fullName\":\"described section failing test\",\"location\":null,\"numPassingAsserts\":0,\"status\":\"failed\",\"title\":\"failing test\"},{\"ancestorTitles\":[\"described section\"],\"duration\":0,\"failureDetails\":[],\"failureMessages\":[],\"fullName\":\"described section skipped test\",\"location\":null,\"numPassingAsserts\":0,\"status\":\"pending\",\"title\":\"skipped test\"}]","failureMessage":"\u001b[1m\u001b[31m  \u001b[1m● \u001b[22m\u001b[1mdescribed section › failing test\u001b[39m\u001b[22m\n\n    \u001b[2mexpect(\u001b[22m\u001b[31mreceived\u001b[39m\u001b[2m).\u001b[22mtoBe\u001b[2m(\u001b[22m\u001b[32mexpected\u001b[39m\u001b[2m) // Object.is equality\u001b[22m\n\n    Expected: \u001b[32m\"b\"\u001b[39m\n    Received: \u001b[31m\"a\"\u001b[39m\n\u001b[2m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m  5 | \u001b[39mdescribe(\u001b[32m\"described section\"\u001b[39m\u001b[33m,\u001b[39m () \u001b[33m=>\u001b[39m {\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m  6 | \u001b[39m  it(\u001b[32m\"failing test\"\u001b[39m\u001b[33m,\u001b[39m () \u001b[33m=>\u001b[39m {\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m\u001b[31m\u001b[1m>\u001b[22m\u001b[2m\u001b[39m\u001b[90m  7 | \u001b[39m    expect(\u001b[32m\"a\"\u001b[39m)\u001b[33m.\u001b[39mtoBe(\u001b[32m\"b\"\u001b[39m)\u001b[33m;\u001b[39m\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m    | \u001b[39m                \u001b[31m\u001b[1m^\u001b[22m\u001b[2m\u001b[39m\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m  8 | \u001b[39m  })\u001b[33m;\u001b[39m\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m  9 | \u001b[39m\u001b[0m\u001b[22m\n\u001b[2m    \u001b[0m \u001b[90m 10 | \u001b[39m  it\u001b[33m.\u001b[39mskip(\u001b[32m\"skipped test\"\u001b[39m\u001b[33m,\u001b[39m () \u001b[33m=>\u001b[39m {})\u001b[33m;\u001b[39m\u001b[0m\u001b[22m\n\u001b[2m\u001b[22m\n\u001b[2m      \u001b[2mat Object.<anonymous> (\u001b[22m\u001b[2m\u001b[0m\u001b[36msrc/ttt1.test.js\u001b[39m\u001b[0m\u001b[2m:7:17)\u001b[22m\u001b[2m\u001b[22m\n\u001b[2m      \u001b[2mat Object.<anonymous> (\u001b[22m\u001b[2mnode_modules/uu5g05-test/src/core.js\u001b[2m:54:27)\u001b[22m\u001b[2m\u001b[22m\n"},{"leaks":false,"numFailingTests":0,"numPassingTests":2,"numPendingTests":0,"numTodoTests":0,"openHandles":[],"perfStats":{"end":1605620313038,"runtime":2370,"slow":false,"start":1605620310668},"skipped":false,"snapshot":{"added":0,"fileDeleted":false,"matched":0,"unchecked":0,"unmatched":0,"updated":0,"uncheckedKeys":[]},"testFilePath":"C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\src\\ttt3.test.js","testResults":"[{\"ancestorTitles\":[\"described section\"],\"duration\":8,\"failureDetails\":[],\"failureMessages\":[],\"fullName\":\"described section console.warn() calling test\",\"location\":null,\"numPassingAsserts\":0,\"status\":\"passed\",\"title\":\"console.warn() calling test\"},{\"ancestorTitles\":[\"described section\"],\"duration\":1,\"failureDetails\":[],\"failureMessages\":[],\"fullName\":\"described section console.error() calling test\",\"location\":null,\"numPassingAsserts\":0,\"status\":\"passed\",\"title\":\"console.error() calling test\"}]","failureMessage":null},{"leaks":false,"numFailingTests":0,"numPassingTests":1,"numPendingTests":0,"numTodoTests":0,"openHandles":[],"perfStats":{"end":1605620312984,"runtime":2302,"slow":false,"start":1605620310682},"skipped":false,"snapshot":{"added":0,"fileDeleted":false,"matched":0,"unchecked":0,"unmatched":0,"updated":0,"uncheckedKeys":[]},"testFilePath":"C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\src\\ttt2.test.js","testResults":"[{\"ancestorTitles\":[\"described section\"],\"duration\":8,\"failureDetails\":[],\"failureMessages\":[],\"fullName\":\"described section console.log() calling test\",\"location\":null,\"numPassingAsserts\":0,\"status\":\"passed\",\"title\":\"console.log() calling test\"}]","failureMessage":null}],"wasInterrupted":false,"consoleMap":{"C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\src\\ttt2.test.js":[{"message":"message in console.log","origin":"    at Object.<anonymous> (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\src\\ttt2.test.js:3:13)\n    at Object.<anonymous> (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\uu5g05-test\\src\\core.js:54:27)\n    at Object.asyncJestTest (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\jasmineAsyncInstall.js:106:37)\n    at C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\queueRunner.js:45:12\n    at new Promise (<anonymous>)\n    at mapper (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\queueRunner.js:28:19)\n    at C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\queueRunner.js:75:41","type":"log"}],"C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\src\\ttt3.test.js":[{"message":"message in console.warn","origin":"    at Object.<anonymous> (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\src\\ttt3.test.js:3:13)\n    at Object.<anonymous> (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\uu5g05-test\\src\\core.js:54:27)\n    at Object.asyncJestTest (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\jasmineAsyncInstall.js:106:37)\n    at C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\queueRunner.js:45:12\n    at new Promise (<anonymous>)\n    at mapper (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\queueRunner.js:28:19)\n    at C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\queueRunner.js:75:41","type":"warn"},{"message":"message in console.error","origin":"    at Object.<anonymous> (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\src\\ttt3.test.js:6:13)\n    at Object.<anonymous> (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\uu5g05-test\\src\\core.js:54:27)\n    at Object.asyncJestTest (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\jasmineAsyncInstall.js:106:37)\n    at C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\queueRunner.js:45:12\n    at new Promise (<anonymous>)\n    at mapper (C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\queueRunner.js:28:19)\n    at C:\\Users\\Ma3oiS\\git\\uu_uu5g04\\uu5g04\\node_modules\\jest-jasmine2\\build\\queueRunner.js:75:41","type":"error"}]}};
  </script>

  <style type="text/css" data-uu-app-styles-insert-before>
    body {
      max-width: 1200px;
    }

    .passed {
      color: #6b9e42;
    }
    .passed-bg {
      background-color: #e0f2bf;
    }
    .failed {
      color: #dd283b;
    }
    .failed-bg {
      background-color: #ffbaba;
    }
    .skipped {
      color: #a0a0a0;
    }
    .skipped-bg {
      background-color: #f0f0f0;
    }

    .summary-item {
      display: flex;
    }
    .summary-item>* {
      flex: none;
    }
    .summary-item-title {
      font-weight: bold;
      min-width: 90px;
    }
    .summary-item>*:nth-child(n+3)::before {
      content: "\00a0/\00a0";
    }

    .test-suite {
      margin: 4px 0;
      line-height: normal;
    }
    .test-suite-summary {
      display: flex;
      padding: 0 5px;
      justify-content: flex-start;
      border-bottom: 1px solid #e0e0e0;
      font-weight: bold;
      cursor: pointer;
    }
    .test-suite-summary>* {
      flex: 0 0 100px;
      padding: 2px 5px;
      text-align: right;
    }
    .test-suite-summary>:first-child {
      flex: 1 0 auto;
      overflow: hidden;
      text-align: left;
      color: #000;
    }
    .test-suite-exec-error {
      font-size: 90%;
      padding-left: 20px;
    }

    .test {
      padding: 2px 5px 2px 25px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 90%;
    }
    .test-summary {
      font-weight: bold;
      cursor: pointer;
    }
    .test-messages {
      font-size: 90%;
      padding-left: 20px;
    }

    .console {
      padding: 2px 5px 2px 25px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 90%;
    }
    .console-origin {
      font-size: 90%;
      padding-left: 20px;
    }
  </style>

</head>
<body>
  <div id="renderHere"></div>

  <script src="https://cdn.plus4u.net/uu-app-templateg01/1.0.0/in-browser-transpilation.min.js" crossorigin="anonymous"></script>
  <script type="text/babel">
    import React from "react";
    import ReactDOM from "react-dom";
    import createReactClass from "create-react-class";
    import UU5 from "uu5g04";
    import "uu5g04-bricks";
    import { createVisualComponent, useState, useEffect } from "uu5g04-hooks";

    function stripAnsi(txt) {
      return txt.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-PRZcf-nqry=><]/g, "");
    }

    const Test = createReactClass({
      mixins: [UU5.Common.BaseMixin, UU5.Common.ElementaryMixin],

      getInitialState() {
        return {
          opened: false
        };
      },
      _onClick(e) {
        e.stopPropagation();
        if (this.props.data.status === "failed") {
          this.setState(state => ({ opened: !state.opened }));
        }
      },
      render() {
        let { status, title, failureMessages, ancestorTitles } = this.props.data;
        return (
          <div className={`test ${status === "pending" ? "skipped skipped-bg" : status + " " + status + "-bg"}`}>
            <div className="test-summary" onClick={this._onClick}>
              {ancestorTitles.concat([title]).join(" / ")}
            </div>
            {this.state.opened && (
              <div>
                {failureMessages.map((it, idx) => <pre className="test-messages" key={idx}>{stripAnsi(it)}</pre>)}
              </div>
            )}
          </div>
        );
      }
    });

    const CONSOLE_ICONS = {
      "error": { icon: "mdi-close-circle", style: { color: UU5.Environment.colors.red.c500 } },
      "warn": { icon: "mdi-alert-circle", style: { color: UU5.Environment.colors.orange.c500 } },
      "log": { icon: "mdi-information", style: { color: UU5.Environment.colors.blue.c500 } },
    };
    const ConsoleLog = createVisualComponent({
      render(props) {
        let { console = [] } = props;
        let result;
        if (console.length) {
          result = (
            <div className="console">
              {console.map((it, i) => (
                <div key={i}>
                  <UU5.Bricks.Icon {...CONSOLE_ICONS[it.type]} />
                  {" " + it.message}
                  <pre className="console-origin">{it.origin}</pre>
                </div>
              ))}
            </div>
          );
        } else {
          result = null;
        }
        return result;
      }
    });

    const TestSuite = createReactClass({
      mixins: [UU5.Common.BaseMixin, UU5.Common.ElementaryMixin],

      getInitialState() {
        return {
          opened: false
        };
      },
      _onClick(e) {
        e.stopPropagation();
        this.setState(state => ({ opened: !state.opened }));
      },
      _getTestResults() {
        let { testResults } = this.props.data;
        let result;
        if (typeof testResults === "string") result = testResults ? JSON.parse(testResults) : [];
        else result = testResults;
        return result;
      },
      _renderConsoleCount(type, icon, color) {
        let console = this.props.console || [];
        let items = console.filter(it => it.type === type);
        let result;
        if (items.length) {
          result = <span>{items.length}<UU5.Bricks.Icon {...CONSOLE_ICONS[type]} /></span>
        } else {
          result = null;
        }
        return result;
      },
      render() {
        let { numPassingTests, numFailingTests, numPendingTests, testExecError, testFilePath, testResults } = this.props.data;
        return (
          <div className="test-suite">
            {this.props.showHeader && (
              <div className="test-suite-summary">
                <span>Test Suite</span>
                <span>Console</span>
                <span>Failed</span>
                <span>Skipped</span>
                <span>Passed</span>
              </div>
            )}
            <div
              className={`test-suite-summary ${(numFailingTests || testExecError) && "failed failed-bg" || numPendingTests && "skipped skipped-bg" || "passed passed-bg"}`}
              onClick={this._onClick}
            >
              <span>{testFilePath}</span>
              <span>
                {this._renderConsoleCount("error")}
                {this._renderConsoleCount("warn")}
                {this._renderConsoleCount("log")}
              </span>
              <span>{numFailingTests}</span>
              <span>{numPendingTests}</span>
              <span>{numPassingTests}</span>
            </div>
            {this.state.opened && this._getTestResults().map((it, idx) => <Test key={idx} data={it} />)}
            {this.state.opened && testExecError ? (
              <pre className="test-suite-exec-error">{stripAnsi(testExecError)}</pre>
            ) : null}
            {this.state.opened && <ConsoleLog console={this.props.console} />}
          </div>
        );
      }
    });

    const Summary = createReactClass({
      mixins: [UU5.Common.BaseMixin],

      render() {
        let { data } = this.props; // testResult object: https://facebook.github.io/jest/docs/en/configuration.html#testresultsprocessor-string
        let { numPassedTestSuites, numFailedTestSuites, numPendingTestSuites, numTotalTestSuites } = data;
        let { numPassedTests, numFailedTests, numPendingTests, numTotalTests } = data;
        let { snapshot, testResults, startTime } = data;
        let endTime = testResults.reduce((r, it) => Math.max(r, it.perfStats.end), 0);
        return (
          <UU5.Bricks.Section>
            <div className="summary-item">
              <span className="summary-item-title">Test suites:</span>
              {numTotalTestSuites && <span className="failed">{numFailedTestSuites} failed</span> || null}
              {numTotalTestSuites && <span className="skipped">{numPendingTestSuites} skipped</span> || null}
              {numTotalTestSuites && <span className="passed">{numPassedTestSuites} passed</span> || null}
              <span>{numTotalTestSuites} total</span>
            </div>
            <div className="summary-item">
              <span className="summary-item-title">Tests:</span>
              {numTotalTests && <span className="failed">{numFailedTests} failed</span> || null}
              {numTotalTests && <span className="skipped">{numPendingTests} skipped</span> || null}
              {numTotalTests && <span className="passed">{numPassedTests} passed</span> || null}
              <span>{numTotalTests} total</span>
            </div>
            <div className="summary-item">
              <span className="summary-item-title">Snapshots:</span>
              {snapshot.total && <span className="failed">{snapshot.unmatched} failed</span> || null}
              {snapshot.total && <span className="passed">{snapshot.matched} passed</span> || null}
              <span>{snapshot.total} total</span>
            </div>
            <div className="summary-item">
              <span className="summary-item-title">Time:</span>
              <span>{((endTime || startTime) - startTime) / 1000}s</span>
            </div>
          </UU5.Bricks.Section>
        );
      }
    });

    const _renderFilesInfo = function(filesMap) {
      let components = [];

      for (let fileName in filesMap) {
        components.push(
          <UU5.Bricks.Row>
            <UU5.Bricks.Column colWidth="xs-12 s-9">{fileName}</UU5.Bricks.Column>
            <UU5.Bricks.Column colWidth="xs-12 s-3">{filesMap[fileName]} times</UU5.Bricks.Column>
          </UU5.Bricks.Row>
        );
      }

      return components;
    };

    const SINGLE_BATCH_MAX_TIME = 10;
    const NEXT_BATCH_DELAY = 0;
    const useComplexComputation = (computationGeneratorFn, deps = []) => {
      let [result, setResult] = useState();
      let isComputing = result === undefined;
      useEffect(() => {
        let time = performance.now();
        let shouldPauseFn = () => performance.now() - time >= SINGLE_BATCH_MAX_TIME;
        let generator = computationGeneratorFn(shouldPauseFn);
        (async () => {
          let done, value, result;
          while (!({ done, value } = generator.next()).done) {
            result = value;
            await new Promise(resolve => setTimeout(resolve, NEXT_BATCH_DELAY));
            time = performance.now();
          }
          if (result === undefined) throw new Error("Complex computation didn't return any result. It must yield value that is not 'undefined'.")
          setResult(result);
        })();
        return () => generator.return();
      }, deps);
      return [result, isComputing];
    }

    const ErrorSet = ({ data }) => {
      let [result, isComputing] = useComplexComputation(function *(shouldPauseFn) {
        let errors = [];
        for (let results of data.testResults) {
          let testResults = typeof results.testResults === "string" ? JSON.parse(results.testResults) : results.testResults;
          if (shouldPauseFn()) yield;
          testResults
            .filter(item => item.status === "failed")
            .forEach(testResults => {
              errors = errors.concat(testResults.failureMessages.map(message => ({message, file: testResults.fullName })));
            });
        }
        if (shouldPauseFn()) yield;
        
        let errorSet = new Set();
        let errorMap = {};
        // only snapshot errors
        for (let {message, file} of errors) {
          let item = message;
          if (shouldPauseFn()) yield;
          let matches = stripAnsi(item).match(/(?:\n\s*(?:\+|-)[^\n]*)+(?:\n|$)/g);
          if (matches){
            matches.map(item => item.trim().replace(/(^|\n)\s*([-+])\s+/g, "$1$2 ")).
            filter(item => item !== "- Snapshot\n+ Received" && item !== "- Expected\n+ Received").
            forEach(item => { 
              errorSet.add(item); 
              errorMap[item] = errorMap[item] || { count: 0 };
              errorMap[item].count++;
              if (errorMap[item][file]) {
                errorMap[item][file]++;
              } else {
                errorMap[item][file] = 1;
              }
            })
          }
        }

        yield { errorSet, errorMap };
      }, [data]);

      let components = [];
      if (isComputing) {
        components.push(<UU5.Bricks.Loading />);
      } else if (result.errorSet.size) {
        let {errorSet, errorMap} = result;
        errorSet.forEach((error, index) => {
          let {count, ...errorFiles} = errorMap[error];
          components.push(
            <UU5.Bricks.Panel
              header={(
                <UU5.Bricks.Row>
                  <UU5.Bricks.Column colWidth="xs-12 s-9"><pre>{error}</pre></UU5.Bricks.Column>
                  <UU5.Bricks.Column colWidth="xs-12 s-3">{count} times</UU5.Bricks.Column>
                </UU5.Bricks.Row>
              )} 
              key={index}
              className={UU5.Common.Css.css(" margin: 16px; .uu5-bricks-panel-header-content { display: block; width: 100%; }")}
            >
              {_renderFilesInfo(errorFiles)}
            </UU5.Bricks.Panel>
          );
        });
      } else {
        components.push("No snapshot errors");
      }

      return (
        <UU5.Bricks.Section>
          {components}
        </UU5.Bricks.Section>
      );
    };

    const Page = createReactClass({
      mixins: [UU5.Common.BaseMixin],

      render() {
        let { data } = this.props; // testResult object: https://facebook.github.io/jest/docs/en/configuration.html#testresultsprocessor-string
        let consoleMap = data.consoleMap || {};
        return (
          <UU5.Bricks.Page>
            <Summary data={data} />
            <UU5.Bricks.Section>
              {data.testResults.map((it, idx) => <TestSuite key={idx} data={it} showHeader={idx === 0} console={consoleMap[it.testFilePath]} />)}
            </UU5.Bricks.Section>
            <ErrorSet data={data} />
          </UU5.Bricks.Page>
        );
      }
    });

    ReactDOM.render(<UU5.Bricks.Loading />, document.getElementById('renderHere'));

    setTimeout(() => {
      let data = document.querySelector("test-data").childNodes[0].data;
      if (data.charAt(0) === "$") data = exampleTestData;
      else data = JSON.parse(data.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&"));
      window.testResult = data;
      ReactDOM.render(<Page data={data} />, document.getElementById('renderHere'));
    }, 0);
  </script>
  <test-data style="display: none;"><!--$testResultHtml$--></test-data>
</body>
</html>
