const path = require("path");

const paths = require("../config/paths.js");
const helpers = require("../tools/helpers.js");
const UuCloudConfig = require("./uu_cloud/uu-cloud-config.js");
const UuCloudLibraryConfig = require("./uu_cloud/uu-cloud-library-config.js");
const Package = require("uu_appg01_devkit-common/src/tools/package.js");

module.exports = class UuAppBox {
  constructor(config) {
    this.config = config;
    this.taskName = "uuAppBox";
  }

  async process() {
    // Ensure project is packaged before uploading to appbox
    await helpers.exec("npm run --loglevel=error package -- " + this.config.toCommandLineArgs().join(" ")); // TODO Escaping.
    Package.getSingletonSync("package.json").loadSync(); // reload as version might have changed

    let { name, version, dependencies, uuBuildSettings } = Package.getSingletonSync("package.json").get();
    let uuCloudConfig = null;
    let templateType = helpers.getTemplateInfo().type;
    if (templateType === "uu5-lib" || templateType === "lib" || templateType === "nodejs-multi") {
      uuCloudConfig = new UuCloudLibraryConfig(
        path.resolve("."),
        name,
        version,
        paths.buildDir,
        this.config,
        dependencies,
        uuBuildSettings,
        this.taskName
      );
    } else {
      uuCloudConfig = new UuCloudConfig(path.resolve("."), name, version, paths.buildDir, this.config, this.taskName);
    }

    const Task = require("./uu_cloud/task-app-box");
    await new Task(uuCloudConfig).process();
  }
};
