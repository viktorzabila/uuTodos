const path = require("path");
const fs = require("fs-extra");
const unzipper = require("unzipper");
const Pack = require("uu_appg01_devkit-common/src/tools/package.js");
const paths = require("../config/paths.js");
const Deploy = require("./npm-deploy.js");

class MultiDeploy extends Deploy {
  async process() {
    // unzip the .tgz files from multi .zip file (just to be consistent if somebody has its own
    // "postpackage" npm script and updates the multi .zip file / something)
    let tmpDir = path.join(paths.buildDir, "npm-deploy-packages");
    fs.emptyDirSync(tmpDir);
    let pkg = Pack.getSingletonSync("package.json").get();
    let zipWithTgz = path.join(paths.buildDir, pkg.name + "-" + pkg.version + "-library-pack.zip");
    await fs
      .createReadStream(zipWithTgz)
      .pipe(unzipper.Extract({ path: tmpDir }))
      .promise();

    let fileList = fs.readdirSync(tmpDir).map((name) => path.resolve(tmpDir, name));
    return super.process(fileList);
  }
}
module.exports = MultiDeploy;
