const path = require("path");
const { exec, resolveByTemplateType } = require("../tools/helpers.js");

module.exports = class Test {
  constructor(config) {
    this.config = config;
  }

  async process() {
    let modules = this.config.getWorkspaceLibraryList();
    console.log("Scanning projects: " + modules.map((it) => it.name).join(", "));

    for (let { name, pkg, type } of modules) {
      if (
        !pkg.scripts.vulnerabilityScan ||
        resolveByTemplateType(path.join(__dirname, "vulnerability-scan.js"), type) == null
      ) {
        continue;
      }
      await exec("npm run vulnerabilityScan -- " + this.config.toCommandLineArgs().join(" "), {
        cwd: path.resolve(name),
      }); // TODO Escaping of arguments
    }
  }
};
